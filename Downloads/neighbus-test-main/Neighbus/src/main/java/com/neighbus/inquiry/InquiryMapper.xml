<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbus.inquiry.InquiryMapper"> 
    
    <insert id="insertInquiry" parameterType="com.neighbus.inquiry.InquiryDTO">
        INSERT INTO inquiries (
        	title,
        	content,
        	writer,
        	category
        )
        VALUES (
            #{title},
            #{content},
            #{writerId},
            #{category}
        )
    </insert>

   <select id="selectAllInquiries" resultType="HashMap">
        SELECT
            i.id,
            i.title,
            i.content,
            i.created_at,
            i.state,
            ic.name AS category,
            u.name AS writer_name,
            u.email AS writer_email,
            i.writer AS writer_id
        FROM inquiries i
        JOIN users u ON i.writer = u.id
        JOIN inquiry_category ic ON i.category = ic.id
        ORDER BY i.created_at DESC
    </select>

    <!-- 문의 상세 조회 -->
    <select id="selectInquiryById" parameterType="int" resultType="map">
        SELECT
            i.id,
            i.title,
            i.content,
            i.created_at,
            i.state,
            i.writer AS writer_id,
            u.name AS writer_name,
            u.email AS writer_email,
            u.username AS writer_username
        FROM inquiries i
        JOIN users u ON i.writer = u.id
        WHERE i.id = #{id}
    </select>

    <!-- 문의 상태 변경 -->
    <update id="updateInquiryState" parameterType="map">
        UPDATE inquiries
        SET state = #{state}
        WHERE id = #{id}
    </update>

    <!-- 문의 삭제 -->
      <delete id="deleteInquiry" parameterType="int">
          DELETE FROM inquiries
          WHERE id = #{id}
      </delete>

      <!-- 문의 댓글 삭제 -->
      <delete id="deleteInquiryComments" parameterType="int">
          DELETE FROM inquiry_comments
          WHERE inquiry = #{inquiryId}
      </delete>

      <!-- 답변(댓글) 추가 -->
      <insert id="insertInquiryComment" parameterType="map">
          INSERT INTO inquiry_comments (inquiry, content, writer)
          VALUES (#{inquiryId}, #{content}, #{writerId})
      </insert>

      <!-- 특정 문의에 대한 답변(댓글) 조회 -->
      <select id="selectInquiryCommentByInquiryId" parameterType="int" resultType="map">
          SELECT
              c.id,
              c.content,
              c.created_at,
              u.name as writer_name
          FROM inquiry_comments c
          JOIN users u ON c.writer = u.id
          WHERE c.inquiry = #{inquiryId}
          ORDER BY c.created_at ASC
      </select>

      <!-- 사용자가 작성한 문의 목록 조회 (답변과 함께) -->
      <select id="selectInquiriesByWriterId" parameterType="int" resultType="map">
          SELECT
              i.id,
              i.title,
              i.content,
              i.state,
              i.created_at,
              (SELECT c.content FROM inquiry_comments c WHERE c.inquiry = i.id ORDER BY c.created_at DESC LIMIT 1) as answer_content,
              (SELECT c.created_at FROM inquiry_comments c WHERE c.inquiry = i.id ORDER BY c.created_at DESC LIMIT 1) as answer_created_at
          FROM
              inquiries i
          WHERE
              i.writer = #{writerId}
          ORDER BY
              i.created_at DESC
      </select>

    </mapper>