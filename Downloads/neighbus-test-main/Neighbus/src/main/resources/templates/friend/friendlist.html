<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEIGHBUS - 친구 목록</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/navibar.css">
    <link rel="stylesheet" href="/css/custom-modal.css">
    <script src="/js/custom-modal.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #A67C52; --primary-dark: #8D6E63; --primary-light: #C9A88A;
            --accent-red: #C87E7E; --bg-ivory: #FFF8F0; --bg-warm: #FFF5EB;
            --card-bg: #FFFBF7; --text-primary: #5D4037; --text-secondary: #8D6E63;
            --border-color: #E8D7C3; --shadow-color: rgba(166, 124, 82, 0.1); --white: #FFFFFF;
        }
        body {
            font-family: 'SUIT', sans-serif; color: var(--text-primary);
            background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, #FAF0E6 100%);
            overflow-x: hidden; min-height: 100vh; padding-top: 100px;
        }
        .main-container {
            max-width: 1200px; margin: 0 auto; padding: 2rem;
            height: calc(100vh - 120px); display: flex; gap: 1.5rem;
            position: relative; overflow: hidden;
        }
        .friend-section {
            flex: 1; background: var(--white); border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%; z-index: 10;
        }
        .friend-section.shrink { flex: 0 0 400px; }
        .section-header {
            padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color);
            background: var(--bg-warm); border-radius: 20px 20px 0 0;
        }
        .section-title-text { font-size: 1.2rem; font-weight: 800; color: var(--text-primary); }
        .friend-list-wrapper { flex: 1; overflow-y: auto; padding: 1rem; }
        .friend-list-wrapper::-webkit-scrollbar { width: 6px; }
        .friend-list-wrapper::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
        .friend-card {
            display: flex; align-items: center; background: var(--card-bg);
            padding: 1rem; border-radius: 12px; margin-bottom: 1rem;
            border: 1px solid transparent; transition: all 0.3s ease;
        }
        .friend-card:hover {
            border-color: var(--primary-light); box-shadow: 0 4px 12px var(--shadow-color);
            transform: translateY(-2px);
        }
        .friend-avatar {
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--bg-ivory); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .friend-info { flex: 1; margin-left: 1rem; }
        .friend-name { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .friend-status { font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px; }
        .friend-actions { display: flex; gap: 0.5rem; }
        .btn-action {
            padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.85rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .btn-chat { background-color: var(--bg-ivory); color: var(--primary); border-color: var(--primary); }
        .btn-chat:hover { background-color: var(--primary); color: var(--white); }
        .btn-delete { background-color: transparent; color: var(--accent-red); }
        .btn-delete:hover { background-color: #FFF0F0; }
        .chat-section {
            position: absolute; right: 2rem; top: 2rem; bottom: 2rem;
            width: calc(100% - 400px - 3.5rem); background: var(--white);
            border-radius: 20px; box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid var(--border-color); display: flex; flex-direction: column;
            transform: translateX(110%); opacity: 0; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5;
        }
        .chat-section.active { transform: translateX(0); opacity: 1; }
        .chat-header {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-warm); border-radius: 20px 20px 0 0;
        }
        .chat-user-info { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .btn-close-chat { background: none; border: none; font-size: 1.2rem; color: var(--text-secondary); cursor: pointer; }
        .chat-body {
            flex: 1; padding: 1.5rem; overflow-y: auto; background-color: var(--bg-ivory);
            display: flex; flex-direction: column; gap: 1rem;
        }
        .chat-bubble {
            max-width: 70%; padding: 0.8rem 1.2rem;
            font-size: 0.95rem; line-height: 1.5; position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-bubble.receive {
            background: var(--white);
            color: var(--text-primary);
            align-self: flex-start;
            border-radius: 4px 18px 18px 18px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .chat-bubble.sent {
            background: linear-gradient(135deg, #FFE082 0%, #FFD54F 100%);
            color: #5D4037;
            align-self: flex-end;
            border-radius: 18px 4px 18px 18px;
            border: 1px solid #FFD54F;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.25);
        }
        .chat-footer {
            padding: 1rem; background: var(--white); border-top: 1px solid var(--border-color);
            border-radius: 0 0 20px 20px;
        }
        .chat-input-group {
            display: flex; gap: 10px; background: var(--bg-warm); padding: 0.5rem;
            border-radius: 50px; border: 1px solid var(--border-color);
        }
        .chat-input { flex: 1; border: none; background: transparent; padding: 0.5rem 1rem; outline: none; font-size: 0.95rem; }
        .btn-send {
            width: 40px; height: 40px; border-radius: 50%; background: var(--primary);
            color: var(--white); border: none; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: background 0.2s;
        }
        .btn-send:hover { background: var(--primary-dark); }
        @media (max-width: 992px) {
            .friend-section.shrink { flex: 0 0 320px; }
            .chat-section { width: calc(100% - 320px - 3.5rem); }
        }
        @media (max-width: 768px) {
            body { padding-top: 80px; }
            .main-container { padding: 1rem; height: calc(100vh - 100px); }
            .friend-section.shrink { display: none; }
            .chat-section {
                width: 100%; right: 0; top: 0; bottom: 0; height: 100%;
                border-radius: 0; transform: translateX(100%);
            }
            .chat-section.active { position: fixed; z-index: 1000; transform: translateX(0); }
            .chat-header { border-radius: 0; }
            .chat-footer { border-radius: 0; }
        }
    </style>

</head>

<body>

    <div th:replace="~{include/navibar :: header-nav}"></div>

    <div class="main-container">
        <div class="friend-section" id="friendSection">
            <div class="section-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="flex-shrink-0">
                        <span class="section-title-text"><i class="bi bi-person-heart me-2"></i>내 친구 목록</span>
                        <span class="badge rounded-pill bg-secondary ms-2" th:text="${#lists.size(friendList)}">0</span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-secondary" 
                                th:data-uuid="${myUuid}" onclick="copyMyUuid(this)">
                            <i class="bi bi-clipboard-check"></i> 내 코드 복사
                        </button>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addFriendModal">
                            <i class="bi bi-plus-lg"></i> 친구 추가
                        </button>
                        <button class="btn btn-sm btn-outline-danger position-relative" data-bs-toggle="modal" data-bs-target="#requestModal">
                            <i class="bi bi-envelope-heart"></i> 받은 요청
                            <span th:if="${!requestList.isEmpty()}" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" th:text="${#lists.size(requestList)}">
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="friend-list-wrapper">
                <div th:if="${#lists.isEmpty(friendList)}" class="text-center py-5">
                    <p class="text-muted">아직 등록된 친구가 없습니다.</p>
                </div>

                <div class="friend-card" th:each="friend : ${friendList}">
                    <img th:src="${friend.image}" 
                         class="friend-avatar" alt="프로필">
                         
                    <div class="friend-info">
                        <div class="friend-name" th:text="${friend.name}"></div>
                       
                    </div>
                    <div class="friend-actions">
                        <button class="btn-action btn-chat" 
                            th:data-name="${friend.name}"
                            th:data-id="${friend.id}"
                            th:data-image="${friend.image}"
                            th:data-username="${friend.username}"
                            onclick="openChat(this)">
                            <i class="bi bi-chat-dots-fill me-1"></i>채팅
                        </button>
                        
                        <button class="btn-action btn-delete" 
                            th:data-id="${friend.id}"
                            onclick="confirmDelete(this)">
                            <i class="bi bi-person-x-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-section" id="chatSection">
            <div class="chat-header">
                <div class="chat-user-info">
                    <img src="" id="chatAvatar" class="friend-avatar" style="width: 35px; height: 35px;" alt="">
                    <span id="chatUserName">사용자 이름</span>
                </div>
                <button class="btn-close-chat" onclick="closeChat()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="chat-body" id="chatBody">
            </div>

            <div class="chat-footer">
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="messageInput" placeholder="메시지를 입력하세요..."
                        onkeypress="handleEnter(event)">
                    <button class="btn-send" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addFriendModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">친구 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-2">친구의 UUID 코드를 입력하세요.</p>
                    <input type="text" id="targetUuid" class="form-control" placeholder="xxxxxxxx-xxxx-xxxx...">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="requestFriend()">요청 보내기</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="requestModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">받은 친구 요청</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div th:if="${#lists.isEmpty(requestList)}" class="text-center py-4 text-muted">
                        새로운 친구 요청이 없습니다.
                    </div>

                    <div th:each="req : ${requestList}"
                        class="d-flex align-items-center justify-content-between mb-3 border-bottom pb-2">
                        <div class="d-flex align-items-center">
                            <img th:src="${req.image}" 
                                 class="rounded-circle me-2"
                                style="width:40px; height:40px; object-fit:cover;">
                            <span class="fw-bold" th:text="${req.name}">이름</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary"
                                th:data-id="${req.id}"
                                onclick="respondFriend(this, 'accept')">수락</button>
                            <button class="btn btn-sm btn-secondary"
                                th:data-id="${req.id}"
                                onclick="respondFriend(this, 'refuse')">거절</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<script>
	        // [중요] 전역 변수 설정
	        var stompClient = null;
	        var currentRoomId = null;
	        var currentRecipientUsername = null;
	        
	        // 타임리프 변수 (문자열 처리를 위해 따옴표 필수)
	        const myUsername = "[[${#authentication.principal.username}]]"; 
	        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	        // ============================================================
	        //  1. window 객체에 함수 등록 (HTML에서 클릭 시 무조건 실행됨)
	        // ============================================================

	        // [채팅방 열기]
	        window.openChat = function(element) {
	            // 요소 가져오기 (함수 실행 시점에 가져와서 Null 에러 방지)
	            const friendSection = document.getElementById('friendSection');
	            const chatSection = document.getElementById('chatSection');
	            const chatUserName = document.getElementById('chatUserName');
	            const chatAvatar = document.getElementById('chatAvatar');
	            const chatBody = document.getElementById('chatBody');

	            // 데이터 속성 가져오기
	            const name = element.getAttribute('data-name');
	            const friendId = element.getAttribute('data-id');
	            const imageUrl = element.getAttribute('data-image');
	            const friendUsername = element.getAttribute('data-username');

	            console.log("채팅 열기:", name, friendId);
	            currentRecipientUsername = friendUsername;

	            // UI 변경
	            if(friendSection) friendSection.classList.add('shrink');
	            if(chatSection) chatSection.classList.add('active');
	            if(chatUserName) chatUserName.innerText = name;
	            
	            // 이미지 처리
	            if (chatAvatar) {
	                if (imageUrl && imageUrl !== 'null' && imageUrl !== '') {
	                    chatAvatar.src = imageUrl;
	                } else {
	                    chatAvatar.src = '/img/profile/default.png';
	                }
	            }
	            
	            // 기존 연결 끊기
	            if (stompClient !== null) {
	                stompClient.disconnect();
	            }
	            
	            if(chatBody) chatBody.innerHTML = ''; // 채팅방 비우기

	            // 방 번호 조회 및 내역 불러오기
	            fetch('/friend/chat/room', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/x-www-form-urlencoded',
	                    [csrfHeader]: csrfToken
	                },
	                body: 'friendId=' + friendId
	            })
	            .then(res => res.json())
	            .then(data => {
	                currentRoomId = data.roomId;
	                if(data.history && chatBody) {
	                    data.history.forEach(msg => displayMessage(msg));
	                }
	                connectStomp(currentRoomId);
	            })
	            .catch(err => {
	                console.error("채팅방 접속 실패:", err);
	            });

	            // 모바일 스크롤 방지
	            if (window.innerWidth <= 768) {
	                document.body.style.overflow = 'hidden';
	            }
	        };

	        // [소켓 연결]
	        function connectStomp(roomId) {
	            var socket = new SockJS('/ws-stomp');
	            stompClient = Stomp.over(socket);
	            stompClient.debug = null; 

	            stompClient.connect({}, function (frame) {
	                console.log('Connected: ' + frame);
	                stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
	                    var message = JSON.parse(chatMessage.body);
	                    displayMessage(message);
	                });
	            });
	        }

	        // [메시지 전송]
	        window.sendMessage = function() {
	            const messageInput = document.getElementById('messageInput');
	            const message = messageInput.value.trim();

	            if (message && stompClient && currentRoomId) {
	                var chatMessage = {
	                    roomId: currentRoomId,
	                    sender: myUsername,
	                    message: message,
	                    messageType: 'TALK',
	                    recipientUsername: currentRecipientUsername
	                };
	                
	                stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
	                messageInput.value = '';
	            }
	        };

	        // [메시지 그리기]
	        function displayMessage(msg) {
	            const chatBody = document.getElementById('chatBody');
	            if(!chatBody) return;

	            const bubble = document.createElement('div');
	            bubble.className = (msg.sender === myUsername) ? 'chat-bubble sent' : 'chat-bubble receive';
	            bubble.innerText = msg.message;
	            chatBody.appendChild(bubble);
	            chatBody.scrollTop = chatBody.scrollHeight;
	        }

	        // [채팅방 닫기]
	        window.closeChat = function() {
	            const friendSection = document.getElementById('friendSection');
	            const chatSection = document.getElementById('chatSection');

	            if(friendSection) friendSection.classList.remove('shrink');
	            if(chatSection) chatSection.classList.remove('active');
	            currentRecipientUsername = null;

	            if (stompClient !== null) {
	                stompClient.disconnect();
	                stompClient = null;
	            }
	            document.body.style.overflow = 'auto';
	        };

	        // [엔터키 처리]
	        window.handleEnter = function(e) {
	            if (e.key === 'Enter') {
	                sendMessage();
	            }
	        };

	        // [친구 삭제]
	        window.confirmDelete = function(element) {
	            const friendId = element.getAttribute('data-id');
                showModal('confirm', '친구 삭제', '정말로 삭제하시겠습니까?', () => {
                    fetch('/friend/delete', {
	                    method: 'POST',
	                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
	                    body: 'friendId=' + friendId
	                }).then(res => res.text()).then(status => {
	                    if(parseInt(status) === 1) {
                            showModal('success', '삭제 완료', '친구를 삭제했습니다.', () => location.reload());
                        }
	                    else {
                            showModal('error', '삭제 실패', '친구 삭제에 실패했습니다.');
                        }
	                });
                });
	        };

	        // [친구 요청]
	        window.requestFriend = function() {
	            const uuidInput = document.getElementById('targetUuid');
	            const uuid = uuidInput.value.trim();
	            if(!uuid) {
                    showModal('warning', '입력 필요', 'UUID를 입력하세요.');
                    return;
                }

	            fetch('/friend/request', {
	                method: 'POST',
	                headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
	                body: 'uuid=' + encodeURIComponent(uuid)
	            }).then(res => res.text()).then(status => {
	                const code = parseInt(status);
	                if (code === 1) {
                        showModal('success', '요청 완료', '친구 요청을 보냈습니다.', () => location.reload());
                    }
	                else if (code === -5) {
                        showModal('info', '알림', '이미 친구 관계입니다.');
                    }
	                else {
                        showModal('error', '요청 실패', '친구 요청에 실패했습니다. (코드: ' + code + ')');
                    }
	            });
	        };

	        // [친구 응답]
	        window.respondFriend = function(element, type) {
	            const friendId = element.getAttribute('data-id');
	            const url = (type === 'accept') ? '/friend/accept' : '/friend/refuse';
                showModal('confirm', '요청 처리', '이 요청을 처리하시겠습니까?', () => {
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
                        body: 'friendId=' + friendId
                    }).then(res => res.text()).then(status => {
                        if(parseInt(status) === 1) {
                            location.reload();
                        }
                        else {
                            showModal('error', '오류', '알 수 없는 오류가 발생했습니다.');
                        }
                    });
                });
	        };

	        // [UUID 복사]
	        function copyMyUuid(element) {
	            const uuid = element.getAttribute('data-uuid');
	            if(uuid) {
	                navigator.clipboard.writeText(uuid).then(() => showModal('success', '복사 완료', '내 코드가 복사되었습니다.'));
	            }
	        };
	    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>