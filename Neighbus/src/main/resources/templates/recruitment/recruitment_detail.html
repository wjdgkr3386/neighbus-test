<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:text="${recruitment.title}">모임 상세</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="/css/navibar.css">
    <link rel="stylesheet" href="/css/custom-modal.css">
    <script src="/js/custom-modal.js"></script>
	
	<style>
		:root {
			--primary: #A67C52;
			--primary-dark: #8D6E63;
			--primary-light: #C9A88A;
			--accent-gold: #D4AF87;
            --accent-red: #C87E7E;
            --accent-red-dark: #B36A6A;
			--secondary: #F5DEB3;
			--secondary-light: #F5E6D3;
			--secondary-lighter: #FAF0E6;
			--bg-ivory: #FFF8F0;
			--bg-warm: #FFF5EB;
			--bg-cream: #FAF0E6;
			--card-bg: #FFFBF7;
			--text-primary: #5D4037;
			--text-secondary: #8D6E63;
			--text-light: #A1887F;
			--border-color: #E8D7C3;
			--shadow-color: rgba(166, 124, 82, 0.15);
			--shadow-hover: rgba(166, 124, 82, 0.25);
			--white: #FFFFFF;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'SUIT', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
			background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, var(--bg-cream) 100%);
			color: var(--text-primary);
			line-height: 1.6;
			min-height: 100vh;
			padding-top: 100px;
			padding-bottom: 60px;
		}

		.container {
			max-width: 900px;
		}

		/* 헤더 영역 */
		.detail-header {
			background: var(--card-bg);
			border: none;
			border-radius: 24px;
			padding: 2.5rem;
			margin-bottom: 1.5rem;
			box-shadow:
				0 2px 8px rgba(166, 124, 82, 0.08),
				0 4px 16px rgba(166, 124, 82, 0.06),
				0 0 0 1px rgba(166, 124, 82, 0.04);
			transition: all 0.3s ease;
			position: relative;
		}

		.detail-header:hover {
			box-shadow:
				0 4px 12px rgba(166, 124, 82, 0.12),
				0 8px 24px rgba(166, 124, 82, 0.08),
				0 0 0 1px rgba(166, 124, 82, 0.06);
			transform: translateY(-2px);
		}

		.detail-title {
			font-size: 2rem;
			font-weight: 800;
			color: var(--text-primary);
			margin-bottom: 1.25rem;
			line-height: 1.4;
		}

		.detail-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
			color: var(--text-secondary);
			font-size: 0.9rem;
			align-items: center;
		}

		.meta-item {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.meta-item i {
			color: var(--primary);
			font-size: 1rem;
		}

		.meta-item strong {
			color: var(--text-primary);
			font-weight: 600;
		}

		.meta-divider {
			color: var(--border-color);
			font-size: 0.75rem;
		}

		/* 콘텐츠 카드 */
		.content-card {
			background: var(--card-bg);
			border: none;
			border-radius: 24px;
			padding: 2rem 2.5rem;
			margin-bottom: 1.5rem;
			box-shadow:
				0 2px 8px rgba(166, 124, 82, 0.08),
				0 4px 16px rgba(166, 124, 82, 0.06),
				0 0 0 1px rgba(166, 124, 82, 0.04);
			transition: all 0.3s ease;
		}

		.content-card:hover {
			box-shadow:
				0 4px 12px rgba(166, 124, 82, 0.12),
				0 8px 24px rgba(166, 124, 82, 0.08),
				0 0 0 1px rgba(166, 124, 82, 0.06);
			transform: translateY(-2px);
		}

		.content-card h2 {
			font-size: 1.25rem;
			font-weight: 700;
			color: var(--text-primary);
			margin-bottom: 1.25rem;
			padding-bottom: 0.75rem;
			border-bottom: 2px solid var(--secondary-lighter);
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.content-card h2 i {
			color: var(--primary);
			font-size: 1.1rem;
		}

		.content-card p {
			color: var(--text-primary);
			line-height: 1.8;
			white-space: pre-wrap;
			font-size: 1rem;
		}

		#map {
			width: 100%;
			height: 350px;
			border-radius: 16px;
			margin-top: 1rem;
			background-color: var(--secondary-lighter);
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--text-secondary);
			font-weight: 500;
			box-shadow: inset 0 2px 4px rgba(166, 124, 82, 0.06);
		}

		/* 버튼 그룹 */
		.button-group {
			display: flex;
			gap: 0.75rem;
			margin-top: 1.5rem;
			padding-top: 1.5rem;
			border-top: 1px solid var(--border-color);
		}

		.button-left {
			display: flex;
			gap: 0.75rem;
			flex: 1;
		}

		.button-right {
			display: flex;
			gap: 0.75rem;
			margin-left: auto;
		}

		/* 부트스트랩 버튼 커스터마이징 */
		.btn {
			border-radius: 12px;
			font-weight: 600;
			padding: 0.6rem 1.25rem;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 8px rgba(166, 124, 82, 0.1);
			font-size: 0.9rem;
		}

		.btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 4px 12px rgba(166, 124, 82, 0.2);
		}

		.btn-primary {
			background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
			border: none;
			color: white;
		}

		.btn-primary:hover {
			background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
			color: white;
		}

		.btn-success {
			background: linear-gradient(135deg, #5A8B73 0%, #4A7A63 100%);
			border: none;
		}

		.btn-success:hover {
			background: linear-gradient(135deg, #4A7A63 0%, #5A8B73 100%);
		}

		.btn-warning {
			background: linear-gradient(135deg, #D4AF87 0%, #C9A88A 100%);
			border: none;
			color: var(--text-primary);
		}

		.btn-warning:hover {
			background: linear-gradient(135deg, #C9A88A 0%, #D4AF87 100%);
			color: var(--text-primary);
		}

		.btn-danger {
			background: linear-gradient(135deg, #C87E7E 0%, #B36A6A 100%);
			border: none;
		}

		.btn-danger:hover {
			background: linear-gradient(135deg, #B36A6A 0%, #C87E7E 100%);
		}

		.btn-secondary,
		.btn-outline-secondary {
			background: var(--white);
			color: var(--text-primary);
			border: 2px solid var(--border-color);
		}

		.btn-secondary:hover,
		.btn-outline-secondary:hover {
			background: var(--secondary-lighter);
			border-color: var(--primary);
			color: var(--primary);
		}

		.btn-chat {
			background: linear-gradient(135deg, var(--accent-gold) 0%, var(--primary-light) 100%);
			color: white;
			border: none;
		}

		.btn-chat:hover {
			background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-gold) 100%);
			color: white;
		}

		/* 인원 정보 강조 */
		.user-count {
			display: inline-block;
			background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary-lighter) 100%);
			color: var(--primary);
			padding: 0.3rem 0.75rem;
			border-radius: 12px;
			font-weight: 700;
			font-size: 0.9rem;
			box-shadow: 0 2px 6px rgba(166, 124, 82, 0.12);
		}

		/* 반응형 디자인 */
		@media (max-width: 768px) {
			body {
				padding-top: 80px;
			}

			.detail-header {
				padding: 1.5rem;
			}

			.detail-title {
				font-size: 1.5rem;
			}

			.detail-meta {
				flex-direction: column;
				gap: 0.5rem;
				align-items: flex-start;
			}

			.meta-divider {
				display: none;
			}

			.content-card {
				padding: 1.5rem;
			}

			.button-group {
				flex-direction: column;
			}

			.button-left,
			.button-right {
				flex-direction: column;
				width: 100%;
			}

			.btn {
				width: 100%;
				justify-content: center;
			}
		}

		/* 신고 버튼 스타일 */
		.btn-report {
			position: absolute;
			top: 2rem;
			right: 2rem;
			width: 45px;
			height: 45px;
			background: rgba(255, 255, 255, 0.9);
			border: 1px solid var(--border-color);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--accent-red);
			font-size: 1.1rem;
			transition: all 0.3s;
			cursor: pointer;
			z-index: 10;
			padding: 0;
		}

		.btn-report:hover {
			background: var(--accent-red);
			color: var(--white);
			transform: scale(1.1);
			box-shadow: 0 4px 10px rgba(200, 126, 126, 0.3);
		}

		/* 신고 모달 스타일 */
		.report-modal-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 9999;
			align-items: center;
			justify-content: center;
		}

		.report-modal-overlay.active {
			display: flex;
		}

		.report-modal-content {
			background: var(--card-bg);
			border-radius: 16px;
			padding: 2rem;
			max-width: 500px;
			width: 90%;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
			animation: modalSlideIn 0.3s ease;
		}

		@keyframes modalSlideIn {
			from { transform: translateY(-50px); opacity: 0; }
			to { transform: translateY(0); opacity: 1; }
		}

		.report-modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
		}

		.report-modal-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--text-primary);
		}

		.report-modal-close {
			background: none;
			border: none;
			font-size: 1.5rem;
			color: var(--text-light);
			cursor: pointer;
			transition: color 0.2s;
		}

		.report-modal-close:hover {
			color: var(--text-primary);
		}

		.report-form-group {
			margin-bottom: 1.5rem;
		}

		.report-form-label {
			display: block;
			font-size: 0.95rem;
			font-weight: 600;
			color: var(--text-primary);
			margin-bottom: 0.5rem;
		}

		.report-form-select, .report-form-textarea {
			width: 100%;
			padding: 0.75rem;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			font-size: 0.95rem;
			font-family: inherit;
			transition: border-color 0.2s;
		}

		.report-form-select:focus, .report-form-textarea:focus {
			outline: none;
			border-color: var(--primary);
		}

		.report-form-textarea {
			resize: vertical;
			min-height: 100px;
		}

		.report-modal-footer {
			display: flex;
			gap: 1rem;
			justify-content: flex-end;
			margin-top: 1.5rem;
		}

		.report-btn {
			padding: 0.75rem 1.5rem;
			border: none;
			border-radius: 8px;
			font-size: 0.95rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
		}

		.report-btn-cancel {
			background: var(--bg-cream);
			color: var(--text-primary);
		}

		.report-btn-cancel:hover {
			background: var(--border-color);
		}

		.report-btn-submit {
			background: var(--accent-red);
			color: var(--white);
		}

		.report-btn-submit:hover {
			background: var(--accent-red-dark);
		}
	</style>
</head>

<body>
	<div th:replace="~{include/navibar :: header-nav}"></div>

	<div class="container my-4" th:object="${recruitment}">

		<div id="recruitment-container" th:data-recruitment-id="*{id}" th:data-club-id="*{clubId}">

			<div class="detail-header">
                <button type="button" class="btn-report" onclick="openReportModal()" title="모임 신고">
					<i class="fa-solid fa-flag"></i>
				</button>

				<h1 class="detail-title" th:text="*{title}">모임 제목이 여기에 표시됩니다</h1>

				<div class="detail-meta">
					<div class="meta-item">
						<i class="fa-solid fa-user"></i>
						<span>작성자 ID: <strong th:text="*{writer}"></strong></span>
					</div>
					<span class="meta-divider">|</span>
					<div class="meta-item">
						<i class="fa-solid fa-calendar-days"></i>
						<span>모임 날짜: <strong th:text="*{meetingDate}"></strong></span>
					</div>
					<span class="meta-divider">|</span>
					<div class="meta-item">
						<i class="fa-solid fa-users"></i>
						<span>인원:
							<span class="user-count">
								<span th:text="${currentUserCount}">0</span> / <span th:text="*{maxUser}"></span>
							</span>
						</span>
					</div>
				</div>
			</div>

			<div class="content-card">
				<h2><i class="fa-solid fa-align-left"></i>모임 내용</h2>
				<p th:text="*{content}">모임 상세 내용이 여기에 표시됩니다.</p>
			</div>

			<div class="content-card">
				<h2><i class="fa-solid fa-location-dot"></i>만날 장소</h2>
				<p th:text="*{address}">만날 장소 주소가 여기에 표시됩니다.</p>
				<div id="map"></div>
			</div>
		</div>

		<div class="button-group">
			<div class="button-left">
				<a href="/club/myClubPage" class="btn btn-secondary">
					<i class="fa-solid fa-list"></i>
					내가 가입한 동아리
				</a>
				
			</div>

			<div class="button-right">
				<button th:if="${isJoined == null or isJoined == false}" onclick="joinRecruitment()" class="btn btn-success">
					<i class="fa-solid fa-user-plus"></i>
					가입하기
				</button>
				<button th:onclick="|openChat('${id}')|" class="btn btn-chat">
					<i class="fa-solid fa-comments"></i> 채팅하기
				</button>
				<a th:unless="${chatRoomExists}" 
				       href="javascript:void(0);" 
				       class="btn btn-chat"
				       th:data-id="${recruitment.id}"
				       th:data-title="${recruitment.title}"
				       onclick="createAndEnterChat(this.getAttribute('data-id'), this.getAttribute('data-title'))">
				        <i class="fa-solid fa-plus"></i> 채팅방 생성
				    </a>
				<button th:if="${isJoined == true}" onclick="withdrawalRecruitment()" class="btn btn-warning">
					<i class="fa-solid fa-user-minus"></i>
					탈퇴하기
				</button>
				<button onclick="deleteRecruitment()" class="btn btn-danger">
					<i class="fa-solid fa-trash"></i>
					삭제
				</button>
			</div>
		</div>
	</div>
    <div id="reportModal" class="report-modal-overlay">
		<div class="report-modal-content">
			<div class="report-modal-header">
				<h2 class="report-modal-title">모임 신고하기</h2>
				<button class="report-modal-close" onclick="closeReportModal()">&times;</button>
			</div>

			<form id="reportForm">
				<div class="report-form-group">
					<label for="reportCategory" class="report-form-label">신고 종류를 선택해주세요</label>
					<select class="report-form-select" id="reportCategory" required>
						<option value="" selected disabled>선택하세요</option>
						<option value="폭력">폭력</option>
						<option value="도박">도박</option>
						<option value="음란">음란</option>
						<option value="사기">사기</option>
						<option value="범죄">범죄</option>
						<option value="사이비">사이비</option>
					</select>
				</div>

				<div class="report-form-group">
					<label for="reportReason" class="report-form-label">신고 사유를 상세히 작성해주세요</label>
					<textarea class="report-form-textarea" id="reportReason" rows="4" placeholder="신고 사유를 상세히 작성해주세요.&#10;&#10;예시:&#10;- 어떤 내용이 문제인지&#10;- 언제 발견했는지&#10;- 어떤 규칙을 위반했는지" required></textarea>
				</div>
			</form>

			<div class="report-modal-footer">
				<button type="button" class="report-btn report-btn-cancel" onclick="closeReportModal()">취소</button>
				<button type="button" class="report-btn report-btn-submit" onclick="submitReport()">신고하기</button>
			</div>
		</div>
	</div>

    <script th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&callback=initMap'}" async defer></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script th:inline="javascript">

		const headers = {'Content-Type': 'application/json'};
		const recruitmentId = document.getElementById('recruitment-container').dataset.recruitmentId;
		const clubId = document.getElementById('recruitment-container').dataset.clubId;

		async function joinRecruitment() {
            showModal('confirm', '모임 가입', '모임에 가입하시겠습니까?', async () => {
                try {
				const response = await fetch('/api/recruitment/join', {
					method: 'POST',
					headers: headers,
					body: JSON.stringify({recruitmentId: recruitmentId})
				});

				const message = await response.text();
				showModal(response.ok ? 'success' : 'error', '가입 결과', message, () => {
                    if (response.ok) {
					    location.reload();
				    }
                });
			} catch (error) {
				console.error('Error joining:', error);
				showModal('error', '오류', '요청 중 오류가 발생했습니다.');
			}
            });
		}

		async function withdrawalRecruitment() {
			showModal('confirm', '모임 탈퇴', '모임에서 탈퇴하시겠습니까?', async () => {
                try {
				const response = await fetch('/api/recruitment/withdrawal', {
					method: 'DELETE',
					headers: headers,
					body: JSON.stringify({recruitmentId: recruitmentId})
				});

				const message = await response.text();
				showModal(response.ok ? 'success' : 'error', '탈퇴 결과', message, () => {
                    if (response.ok) {
					    location.reload();
				    }
                });
			} catch (error) {
					console.error('Error withdrawing:', error);
				showModal('error', '오류', '요청 중 오류가 발생했습니다.');
			}
            });
		}

		async function deleteRecruitment() {
			showModal('confirm', '모임 삭제', '정말로 이 모임을 삭제하시겠습니까? (작성자만 가능)', async () => {
                try {
				const response = await fetch(`/api/recruitment/${recruitmentId}`, {
					method: 'DELETE',
					headers: headers
				});

				const message = await response.text();
                showModal(response.ok ? 'success' : 'error', '삭제 결과', message, () => {
				    if (response.ok) {
					    window.location.href = '/club/' + clubId;
				    }
                });
			} catch (error) {
				console.error('Error deleting:', error);
				showModal('error', '오류', '요청 중 오류가 발생했습니다.');
			}
            });
		}

		function openChat(id) {
			window.open('/chat/room/enter/' + id, '_blank', 'width=850,height=750,resizable=yes');
		}

		function createAndEnterChat(recruitId, recruitTitle) {
			var params = new URLSearchParams();
			params.append("roomId", recruitId);
			params.append("name", recruitTitle);

			axios.post('/chat/room', params)
				.then(function (response) {
					var url = "/chat/room/enter/" + recruitId;
					window.open(url, "ChatRoom_" + recruitId, "width=500,height=700,scrollbars=yes,resizable=yes");
				})
				.catch(function (error) {
					console.error("채팅방 생성 실패:", error);
					showModal('error', '채팅방 입장 실패', '채팅방 입장에 실패했습니다. (로그인을 확인해주세요)');
				});
		}

		function initMap() {
			const lat = parseFloat(/*[[${recruitment.latitude}]]*/);
			const lng = parseFloat(/*[[${recruitment.longitude}]]*/);
			const placeName = /*[[${recruitment.address}]]*/ '만남의 장소';
			const mapContainer = document.getElementById('map');
			
			if (!isNaN(lat) && !isNaN(lng)) {
                const location = { lat: lat, lng: lng };
				const map = new google.maps.Map(mapContainer, {
					center: location,
					zoom: 15
				});

				const marker = new google.maps.Marker({
					position: location,
                    map: map,
                    title: placeName
				});

                const infowindow = new google.maps.InfoWindow({
					content: `<div style="padding:5px;font-size:12px;text-align:center;">${placeName}</div>`
				});
				infowindow.open(map, marker);
			} else {
				mapContainer.innerHTML = '위치 정보가 등록되지 않은 모임입니다.';
			}
		};

        // 신고 관련 스크립트
		document.addEventListener('DOMContentLoaded', () => {
			const reportModal = document.getElementById('reportModal');
			if (reportModal) {
				reportModal.addEventListener('click', function(e) {
					if (e.target === this) {
						closeReportModal();
					}
				});
			}
		});

		function openReportModal() {
			document.getElementById('reportModal').classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeReportModal() {
			document.getElementById('reportModal').classList.remove('active');
			document.body.style.overflow = '';
			const reportForm = document.getElementById('reportForm');
			if (reportForm) {
				reportForm.reset();
			}
		}

		async function submitReport() {
			const category = document.getElementById('reportCategory').value;
			const reason = document.getElementById('reportReason').value;

			if (!category) {
				showModal('warning', '입력 필요', '신고 종류를 선택해주세요.');
				return;
			}

			if (!reason.trim()) {
				showModal('warning', '입력 필요', '신고 사유를 상세히 작성해주세요.');
				return;
			}

			const gatheringId = /*[[${recruitment.id}]]*/ 0;
			const reporterId = /*[[${#authentication.principal?.id}]]*/ 0;

			if (!gatheringId || !reporterId) {
				showModal('error', '오류', '로그인이 필요하거나 모임 정보를 불러올 수 없습니다.');
				return;
			}

			try {
				const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
				const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

				const headers = {
					'Content-Type': 'application/json'
				};

				if (csrfToken && csrfHeader) {
					headers[csrfHeader] = csrfToken;
				}

				const response = await fetch('/api/reports/submit', {
					method: 'POST',
					headers: headers,
					body: JSON.stringify({
						type: 'GATHERING',
						reporterId: reporterId,
						targetId: gatheringId,
						category: category,
						reason: reason
					})
				});

				const result = await response.json();

				if (result.status === 1) {
					showModal('success', '접수 완료', '신고가 접수되었습니다. 검토 후 조치하겠습니다.', () => {
                        closeReportModal();
                    });
				} else {
					showModal('error', '접수 실패', '신고 접수에 실패했습니다: ' + (result.message || '알 수 없는 오류'));
				}
			} catch (error) {
				console.error('신고 접수 오류:', error);
				showModal('error', '오류', '신고 접수 중 오류가 발생했습니다.');
			}
		}
	</script>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>