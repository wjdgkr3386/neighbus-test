<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ë² ì´ì§€ & ì›œ ë¸Œë¼ìš´ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ */
        :root {
            /* ë©”ì¸ í¬ì¸íŠ¸: ë¶€ë“œëŸ¬ìš´ ë¸Œë¼ìš´ (ë¼ë–¼ ìƒ‰ìƒ) */
            --main-color: #8d6e63; 
            /* í˜¸ë²„ ì‹œ: ì¡°ê¸ˆ ë” ì§„í•œ ë¸Œë¼ìš´ (ì»¤í”¼ ìƒ‰ìƒ) */
            --main-color-hover: #6d4c41; 
            /* ë°°ê²½ìƒ‰: ì•„ì£¼ ì—°í•œ í¬ë¦¼ ë² ì´ì§€ (ë©”ì¸ í˜ì´ì§€ ë² ì´ì§€ì™€ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°) */
            --bg-color: #fdfbf7; 
            /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ: ì™„ì „ ê²€ì •ë³´ë‹¤ëŠ” ì§„í•œ ê³ ë™ìƒ‰ì´ ë² ì´ì§€ì™€ ì˜ ì–´ìš¸ë¦¼ */
            --text-dark: #4e342e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
        }

        /* ì»¤ìŠ¤í…€ í…Œë§ˆ í´ë˜ìŠ¤ */
        .bg-theme {
            background-color: var(--main-color) !important;
        }
        
        .btn-theme {
            background-color: var(--main-color);
            color: white;
            border: none;
        }

        .btn-theme:hover {
            background-color: var(--main-color-hover);
            color: white;
        }
        
        /* ì‰ë„ìš°ë„ ì•½ê°„ ë”°ëœ»í•œ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .shadow-warm {
            box-shadow: 0 10px 30px rgba(141, 110, 99, 0.15) !important;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #chatBox::-webkit-scrollbar {
            width: 6px;
        }
        #chatBox::-webkit-scrollbar-thumb {
            background-color: #d7ccc8; /* ì—°í•œ ë¸Œë¼ìš´ */
            border-radius: 10px;
        }
    </style>
</head>
<body class="d-flex justify-content-center align-items-center min-vh-100 p-3">

    <div class="card shadow-warm border-0 rounded-4 w-100" style="max-width: 800px; height: 600px; display: flex; flex-direction: column;">
        
        <div class="card-header bg-theme text-white text-center p-4 border-0" style="border-radius: 20px 20px 0 0;">
            <h1 class="h5 fw-bold m-0">ğŸ¤– Chat Assistant</h1>
        </div>

        <div id="chatBox" class="card-body bg-white overflow-auto p-4" style="flex: 1;">
            <div class="d-flex justify-content-start mb-3">
                <div class="p-3 rounded-4 bg-light border" style="max-width: 75%; color: var(--text-dark);">
                    ì•ˆë…•í•˜ì„¸ìš”! ë”°ëœ»í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                </div>
            </div>
        </div>

        <div class="card-footer bg-white p-4 border-top-0" style="border-radius: 0 0 20px 20px;">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control rounded-pill border-0 me-2 px-3 py-3" 
                       placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                       style="font-size: 15px; background-color: #f5f5f5;">
                <button id="sendButton" class="btn btn-theme rounded-pill fw-bold px-4" type="button">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        let currentAssistantMessage = null;

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        function addUserMessage(message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'd-flex justify-content-end mb-3 animation-fade-in';
            
            // ì‚¬ìš©ì ë§í’ì„ : í…Œë§ˆ ë¸Œë¼ìš´ ì»¬ëŸ¬
            const bubble = document.createElement('div');
            bubble.className = 'p-3 rounded-4 text-white bg-theme shadow-sm';
            bubble.style.maxWidth = '75%';
            bubble.style.wordWrap = 'break-word';
            bubble.style.borderBottomRightRadius = '4px'; 
            bubble.textContent = message;

            messageWrapper.appendChild(bubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Assistant ë©”ì‹œì§€ ê³µê°„ ìƒì„±
        function createAssistantMessage() {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'd-flex justify-content-start mb-3 animation-fade-in';

            // ë´‡ ë§í’ì„ : ê¹”ë”í•œ í™”ì´íŠ¸/ì—°íšŒìƒ‰
            const bubble = document.createElement('div');
            bubble.className = 'message-content p-3 rounded-4 bg-light border shadow-sm';
            bubble.style.maxWidth = '75%';
            bubble.style.wordWrap = 'break-word';
            bubble.style.borderBottomLeftRadius = '4px'; 
            bubble.style.color = '#4e342e'; // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì§€ì •

            messageWrapper.appendChild(bubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
            return bubble;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addUserMessage(message);
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.style.opacity = '0.7';

            currentAssistantMessage = createAssistantMessage();

            try {
                const response = await fetch(`/chatbot/api/chat/stream?message=${encodeURIComponent(message)}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = "";

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    content += chunk;
                    currentAssistantMessage.textContent = content;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                currentAssistantMessage.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                console.error('Error:', error);
            }
            
            sendButton.disabled = false;
            sendButton.style.opacity = '1';
            currentAssistantMessage = null;
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animation-fade-in {
                animation: fadeIn 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>