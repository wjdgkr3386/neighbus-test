<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI Chat</title>
    <link rel="stylesheet" href="/chat.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ¤– Spring AI Chat (Sync)</h1>
    </div>
    <div class="chat-box" id="chatBox">
        <div class="message assistant">
            <div class="message-content">
                ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
    </div>
    <div class="input-area">
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="sendButton">ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    let currentAssistantMessage = null;

    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        messageDiv.innerHTML = `<div class="message-content">${escapeHtml(message)}</div>`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function createAssistantMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        messageDiv.appendChild(contentDiv);
        chatBox.appendChild(messageDiv);
        return contentDiv;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        addUserMessage(message);
        messageInput.value = '';
        sendButton.disabled = true;

        currentAssistantMessage = createAssistantMessage();
        let fullResponse = '';

        try {
            const response = await fetch(`/chatbot/api/chat/sync?message=${encodeURIComponent(message)}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const content = await response.text();
            currentAssistantMessage.textContent = content;
        } catch (error) {
            currentAssistantMessage.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            console.error('Error:', error);
        }
        sendButton.disabled = false;
        currentAssistantMessage = null;
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>
</body>
</html>
